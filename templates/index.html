{% extends "base.html" %}

{% block title %}RIDOT Bluebook Index Program{% endblock %}

{% block content %}
<div class="dropdown-container">
    <center><h1>RIDOT Bluebook Index</h1></center>
    <form id="pdf-form">
        <!-- Dropdown for selecting PDF -->
        <label for="pdf-select">Select Bluebook:</label>
        <select id="pdf-select" name="pdf_file">
            <option value="">--Select PDF--</option>
            {% for pdf_info in pdf_files %}
            <option value="{{ pdf_info.file }}">{{ pdf_info.name }}</option>
            {% endfor %}
        </select>

        <br><br>
        {% set selects = [
            {'id': 'part', 'label': 'Part'},
            {'id': 'section', 'label': 'Section'},
            {'id': 'subsection', 'label': 'Subsection'}
        ] %}
        
        <!-- Loop to generate select dropdowns for Part, Section, and Subsection -->
        {% for select in selects %}
        <label for="{{ select.id }}-select" id="{{ select.id }}-label" class="disabled-label">Select {{ select.label }}:</label>
        <select id="{{ select.id }}-select" name="{{ select.id }}_title" disabled>
            <option value="">--Select {{ select.label }}--</option>
        </select>
        <br><br>
        {% endfor %}
    </form>
</div>

<!-- JavaScript -->
<script>
    $(document).ready(function () {
        // Function to reset a select dropdown and its label
        const resetSelect = (selectId, labelId) => {
            $(selectId).empty().prop('disabled', true).append($('<option>', { value: '', text: '--Select--' }));
            $(labelId).addClass('disabled-label');
        };

        // Function to populate a select dropdown
        const populateSelect = (url, data, selectId, labelId, formatOption = item => item) => {
            $.post(url, data, function(response) {
                $(selectId).prop('disabled', false).empty().append($('<option>', { value: '', text: '--Select--' }));
                response.forEach(item => $(selectId).append($('<option>', { value: formatOption(item), text: item })));
                $(labelId).removeClass('disabled-label');
            });
        };

        // Event handler for changing the PDF selection
        $('#pdf-select').change(function () {
            const pdfFile = $(this).val();
            // Reset all select dropdowns except PDF
            ['#part-select', '#section-select', '#subsection-select'].forEach((id, idx) => resetSelect(id, `#${['part', 'section', 'subsection'][idx]}-label`));
            if (pdfFile) {
                // Populate Part dropdown based on selected PDF
                populateSelect('/get_part_titles', { pdf_file: pdfFile }, '#part-select', '#part-label');
            }
        });

        // Event handler for changing the Part selection
        $('#part-select').change(function () {
            const partTitle = $(this).val();
            // Reset Section and Subsection dropdowns
            resetSelect('#section-select', '#section-label');
            resetSelect('#subsection-select', '#subsection-label');
            if (partTitle) {
                // Populate Section dropdown based on selected Part
                const pdfFile = $('#pdf-select').val();
                populateSelect('/get_section_titles', { pdf_file: pdfFile, part_title: partTitle }, '#section-select', '#section-label', item => item.split(' ')[1]);
            }
        });

        // Event handler for changing the Section selection
        $('#section-select').change(function () {
            const sectionNumber = $(this).val();
            // Reset Subsection dropdown
            resetSelect('#subsection-select', '#subsection-label');
            if (sectionNumber) {
                // Populate Subsection dropdown based on selected Section
                const pdfFile = $('#pdf-select').val();
                populateSelect('/get_subsections', { pdf_file: pdfFile, section_number: sectionNumber }, '#subsection-select', '#subsection-label');
            }
        });
    });
</script>
{% endblock %}

